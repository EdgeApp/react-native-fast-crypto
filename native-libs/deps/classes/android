inherit common

# Builds a library using the Andorid NDK.
# $1 arch name for toolchain, work_dir and install_dir.
# $2 cross-compiler prefix.
build_android() {
    # Put the source in the working directory:
    work_dir=$work_dir/android-$1
    mkdir -p $work_dir
    unpack

    # Establish expected variables:
    target=android-$1
    install_dir=$build_dir/prefix/android/$1

    cross=$2
    # NDK 28.0 integrated toolchain paths
    ndk_toolchain="$build_dir/ndk/$1"
    export AR="${ndk_toolchain}/bin/llvm-ar"
    export AS="${ndk_toolchain}/bin/${cross}24-clang"
    export CC="${ndk_toolchain}/bin/${cross}24-clang"
    export CCLD="${ndk_toolchain}/bin/${cross}24-clang"
    export CPP="${ndk_toolchain}/bin/${cross}24-clang -E"
    export CXX="${ndk_toolchain}/bin/${cross}24-clang++"
    export LD="${ndk_toolchain}/bin/ld.lld"
    export NM="${ndk_toolchain}/bin/llvm-nm"
    export OBJCOPY="${ndk_toolchain}/bin/llvm-objcopy"
    export OBJDUMP="${ndk_toolchain}/bin/llvm-objdump"
    export RANLIB="${ndk_toolchain}/bin/llvm-ranlib"
    export STRINGS="${ndk_toolchain}/bin/llvm-strings"
    export STRIP="${ndk_toolchain}/bin/llvm-strip"

    export CFLAGS="-isystem${install_dir}/include -fPIC -O2 -DANDROID_SUPPORT_FLEXIBLE_PAGE_SIZES=ON -ffunction-sections -fdata-sections"
    export CXXFLAGS="-isystem${install_dir}/include -fPIC -O2 -DANDROID_SUPPORT_FLEXIBLE_PAGE_SIZES=ON -ffunction-sections -fdata-sections"
    export LDFLAGS="-L${install_dir}/lib -fPIC -Wl,-z,max-page-size=16384 -Wl,-z,common-page-size=16384 -Wl,--gc-sections"

    if [ $1 = "arm" ]; then
        export CFLAGS="$CFLAGS -march=armv7-a -mfloat-abi=softfp -mfpu=vfpv3-d16 -mthumb"
        export CXXFLAGS="$CXXFLAGS -march=armv7-a -mfloat-abi=softfp -mfpu=vfpv3-d16 -mthumb"
        export LDFLAGS="$LDFLAGS -march=armv7-a -Wl,--fix-cortex-a8"
    elif [ $1 = "x86" ] || [ $1 = "x86_64" ]; then
        # Only add -maes for x86 architectures (arm64 doesn't support -maes)
        export CFLAGS="$CFLAGS -maes"
        export CXXFLAGS="$CXXFLAGS -maes"
    fi

    export PATH=${ndk_toolchain}/bin:$PATH
    export PKG_CONFIG_PATH=$install_dir/lib/pkgconfig

    cd $work_dir
    build
}
build_android_arm() {
    build_android arm armv7a-linux-androideabi
}
build_android_arm64() {
    build_android arm64 aarch64-linux-android
}
build_android_x86() {
    build_android x86 i686-linux-android
}
build_android_x86_64() {
    build_android x86_64 x86_64-linux-android
}

for arch in arm arm64 x86 x86_64; do
    deps="download ndk.setup-$arch"
    for dep in $depends; do
        deps="$deps $dep.build-android-$arch"
    done
    task build-android-$arch $deps
done
default=build-android-arm
